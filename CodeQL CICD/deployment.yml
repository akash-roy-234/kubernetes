name: Deployment to Azure Kubernetes

on:
  push:
    branches:
      - develop

jobs:
    deploy:
      runs-on: self-hosted
      steps:
      - name: Checkout code
        uses: actions/checkout@v2

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log into Azure using GitHub secret AZURE_CREDENTIALS
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build Docker image
        run: |
          docker build -t orxpbmm3puscdevacr.azurecr.io/orx-m3p-experience-api:${{ github.run_number }} -f ./deployment/development/Dockerfile .
          echo "${{ secrets.ACR_PASSWORD }}" | docker login orxpbmm3puscdevacr.azurecr.io --username ${{ secrets.ACR_USERNAME }} --password-stdin
          docker push orxpbmm3puscdevacr.azurecr.io/orx-m3p-experience-api:${{ github.run_number }}

      - name: Deploy to Kubernetes
        run: kubectl apply -f ./deployment/development/deployment.yml
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
